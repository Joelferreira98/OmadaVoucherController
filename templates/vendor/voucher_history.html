{% extends "base.html" %}

{% block title %}Histórico de Vouchers - {{ site.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>Histórico de Vouchers</h1>
                <small class="text-muted">Site: {{ site.name }}</small>
            </div>
            <div>
                <a href="{{ url_for('create_vouchers') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Gerar Novos Vouchers
                </a>
                <a href="{{ url_for('vendor_dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Voltar ao Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Summary -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-ticket-alt fa-2x text-primary mb-2"></i>
                <h4 class="text-primary">{{ total_vouchers }}</h4>
                <p class="text-muted mb-0">Total de Vouchers</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-dollar-sign fa-2x text-success mb-2"></i>
                <h4 class="text-success">R$ {{ total_revenue|currency }}</h4>
                <p class="text-muted mb-0">Receita Total</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-layer-group fa-2x text-info mb-2"></i>
                <h4 class="text-info">{{ total_groups }}</h4>
                <p class="text-muted mb-0">Grupos de Vouchers</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-calendar-alt fa-2x text-warning mb-2"></i>
                <h4 class="text-warning">{{ avg_per_day|round(0)|int }}</h4>
                <p class="text-muted mb-0">Média por Dia</p>
            </div>
        </div>
    </div>
</div>

<!-- Filter and Search -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Filtros</h6>
            </div>
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Plano</label>
                        <select name="plan_id" class="form-select">
                            <option value="">Todos os Planos</option>
                            {% for plan in plans %}
                                <option value="{{ plan.id }}" {% if plan.id == selected_plan_id %}selected{% endif %}>
                                    {{ plan.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data Início</label>
                        <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data Fim</label>
                        <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="fas fa-filter me-2"></i>Filtrar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Voucher Groups Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Grupos de Vouchers</h5>
                <small class="text-muted">{{ voucher_groups|length }} registro(s) encontrado(s)</small>
            </div>
            <div class="card-body">
                {% if voucher_groups %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Plano</th>
                                    <th>Quantidade</th>
                                    <th>Valor Total</th>
                                    <th>Status</th>
                                    <th>Omada ID</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vg in voucher_groups %}
                                <tr>
                                    <td>
                                        <div>{{ vg.created_at.strftime('%d/%m/%Y') }}</div>
                                        <small class="text-muted">{{ vg.created_at.strftime('%H:%M') }}</small>
                                    </td>
                                    <td>
                                        <div>{{ vg.plan.name }}</div>
                                        <small class="text-muted">R$ {{ vg.plan.price|currency }} cada</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ vg.quantity }}</span>
                                    </td>
                                    <td>
                                        <strong>R$ {{ vg.total_value|currency }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if vg.status == 'active' else 'secondary' }}">
                                            {{ vg.status.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if vg.omada_group_id %}
                                            <code class="small">{{ vg.omada_group_id[:8] }}...</code>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('download_vouchers', voucher_group_id=vg.id) }}" 
                                               class="btn btn-sm btn-outline-primary" 
                                               title="Baixar PDF">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-info" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#detailsModal{{ vg.id }}"
                                                    title="Ver Detalhes">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination would go here if needed -->
                    
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nenhum voucher encontrado com os filtros aplicados.</p>
                        <a href="{{ url_for('create_vouchers') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Gerar Primeiro Voucher
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Details Modals -->
{% for vg in voucher_groups %}
<div class="modal fade" id="detailsModal{{ vg.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Grupo de Vouchers</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informações Gerais</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Data:</strong></td>
                                <td>{{ vg.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                            </tr>
                            <tr>
                                <td><strong>Plano:</strong></td>
                                <td>{{ vg.plan.name }}</td>
                            </tr>
                            <tr>
                                <td><strong>Quantidade:</strong></td>
                                <td>{{ vg.quantity }}</td>
                            </tr>
                            <tr>
                                <td><strong>Valor Total:</strong></td>
                                <td>R$ {{ vg.total_value|currency }}</td>
                            </tr>
                            <tr>
                                <td><strong>Status:</strong></td>
                                <td>
                                    <span class="badge bg-{{ 'success' if vg.status == 'active' else 'secondary' }}">
                                        {{ vg.status.title() }}
                                    </span>
                                </td>
                            </tr>
                            {% if vg.omada_group_id %}
                            <tr>
                                <td><strong>Omada ID:</strong></td>
                                <td><code>{{ vg.omada_group_id }}</code></td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Detalhes do Plano</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Duração:</strong></td>
                                <td>{{ vg.plan.duration|duration(vg.plan.duration_unit) }}</td>
                            </tr>
                            <tr>
                                <td><strong>Preço:</strong></td>
                                <td>R$ {{ vg.plan.price|currency }}</td>
                            </tr>
                            {% if vg.plan.data_quota %}
                            <tr>
                                <td><strong>Franquia:</strong></td>
                                <td>{{ vg.plan.data_quota }} MB</td>
                            </tr>
                            {% endif %}
                            {% if vg.plan.download_speed %}
                            <tr>
                                <td><strong>Velocidade:</strong></td>
                                <td>{{ vg.plan.download_speed }}/{{ vg.plan.upload_speed or 0 }} Mbps</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
                
                {% if vg.voucher_codes %}
                <div class="mt-3">
                    <h6>Codes de Vouchers ({{ vg.voucher_codes|length }})</h6>
                    <div class="bg-light p-3 rounded">
                        <div class="row">
                            {% for code in vg.voucher_codes[:20] %}
                            <div class="col-md-3 mb-1">
                                <code class="small">{{ code }}</code>
                            </div>
                            {% endfor %}
                        </div>
                        {% if vg.voucher_codes|length > 20 %}
                        <div class="mt-2">
                            <small class="text-muted">
                                ... e mais {{ vg.voucher_codes|length - 20 }} código(s). 
                                <a href="{{ url_for('download_vouchers', voucher_group_id=vg.id) }}">
                                    Baixar PDF completo
                                </a>
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <a href="{{ url_for('download_vouchers', voucher_group_id=vg.id) }}" class="btn btn-primary">
                    <i class="fas fa-download me-2"></i>Baixar PDF
                </a>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
// Auto-set end date to today if start date is selected
document.querySelector('input[name="start_date"]').addEventListener('change', function() {
    const endDate = document.querySelector('input[name="end_date"]');
    if (this.value && !endDate.value) {
        endDate.value = new Date().toISOString().split('T')[0];
    }
});

// Export functionality
function exportToCSV() {
    const table = document.querySelector('table');
    const rows = Array.from(table.querySelectorAll('tr'));
    
    const csv = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        return cells.map(cell => cell.textContent.trim()).join(',');
    }).join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'voucher_history.csv';
    a.click();
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}